# 宝塔面板部署指南

本指南将帮助您将 Next.js 项目部署到宝塔面板上。

## 前置要求

- 已安装宝塔面板的 Linux 服务器（推荐 Ubuntu 20.04+ 或 CentOS 7+）
- 已绑定域名（可选，也可以使用 IP 访问）
- 基本的服务器操作知识

## 一、宝塔面板环境准备

### 1.1 安装 Node.js

1. 登录宝塔面板
2. 进入 **软件商店** → 搜索 **Node.js 版本管理器**
3. 安装 **Node.js 版本管理器**
4. 打开 Node.js 版本管理器，安装 **Node.js 18.x LTS** 或更高版本
5. 设置为默认版本

### 1.2 安装 PM2 管理器

1. 在 **软件商店** 搜索 **PM2 管理器**
2. 安装 PM2 管理器（用于进程管理和自动重启）

### 1.3 安装 Nginx

1. 在 **软件商店** 搜索 **Nginx**
2. 安装最新版本的 Nginx

## 二、上传项目文件

### 2.1 方式一：通过宝塔面板上传

1. 在宝塔面板进入 **文件** 管理
2. 进入 `/www/wwwroot/` 目录
3. 创建项目目录，例如：`hsfzfx`
4. 上传项目压缩包（zip 格式）
5. 解压文件到当前目录

### 2.2 方式二：通过 Git 克隆（推荐）

1. 在宝塔面板打开 **终端**
2. 进入网站目录：
   ```bash
   cd /www/wwwroot
   ```
3. 克隆项目：
   ```bash
   git clone <你的仓库地址> hsfzfx
   cd hsfzfx
   ```

## 三、安装项目依赖

### 3.1 在宝塔终端中执行

```bash
cd /www/wwwroot/hsfzfx
npm install
```

如果安装速度慢，可以使用国内镜像：

```bash
npm install --registry=https://registry.npmmirror.com
```

## 四、配置环境变量

### 4.1 创建 .env 文件

1. 在宝塔面板 **文件** 管理中，进入项目目录
2. 创建 `.env` 文件（注意文件名以点开头）
3. 添加以下内容：

```env
# 数据库配置（SQLite）
# 使用绝对路径更可靠，或者使用相对路径（相对于项目根目录）
DATABASE_URL="file:/www/wwwroot/hsfzfx/prisma/prisma/dev.db"

# Node.js 环境
NODE_ENV=production
PORT=3000

# ============================================
# 后台管理配置
# ============================================
# 后台管理员密码（必填，用于 /admin 登录）
ADMIN_PASSWORD=your_secure_password_here

# 如果使用 HTTP（未配置 SSL）访问，需要设置此项
# 配置 HTTPS 后，请删除此项以提高安全性
FORCE_HTTP=true

# 如果需要其他环境变量，在这里添加
```

**重要提示**：
- ⚠️ **必须设置 `ADMIN_PASSWORD`**，否则无法登录后台
- ⚠️ **如果使用 HTTP 访问**（未配置 SSL），必须设置 `FORCE_HTTP=true`
- ✅ **配置 HTTPS 后**，删除 `FORCE_HTTP=true` 以提高安全性
- ✅ **生产环境建议配置 HTTPS**（免费 Let's Encrypt 证书）

**注意**：如果使用相对路径，确保路径是相对于项目根目录的：
```env
DATABASE_URL="file:./prisma/prisma/dev.db"
```

### 4.2 设置文件权限

确保 `.env` 文件权限正确：
- 在文件管理中右键 `.env` → **权限**
- 设置为 `644` 或 `600`（更安全）

## 五、初始化数据库

### 5.1 确保数据库目录存在

```bash
cd /www/wwwroot/hsfzfx
# 确保 prisma/prisma 目录存在
mkdir -p prisma/prisma
```

### 5.2 生成 Prisma Client

```bash
cd /www/wwwroot/hsfzfx
npm run prisma:generate
```

### 5.3 运行数据库迁移

```bash
cd /www/wwwroot/hsfzfx
npm run prisma:migrate
```

**重要**：如果迁移命令失败，可以尝试：

```bash
# 方式一：开发模式迁移（会提示创建数据库）
npx prisma migrate dev

# 方式二：生产模式迁移
npx prisma migrate deploy

# 方式三：如果数据库文件不存在，先初始化
npx prisma db push
```

### 5.4 验证数据库文件

迁移完成后，检查数据库文件是否创建成功：

```bash
ls -la prisma/prisma/dev.db
```

如果文件不存在，需要手动创建：

```bash
# 创建空数据库文件
touch prisma/prisma/dev.db

# 然后再次运行迁移
npm run prisma:migrate
```

### 5.5 设置数据库文件权限

```bash
# 确保数据库目录和文件有正确的权限
chmod 755 prisma/prisma
chmod 666 prisma/prisma/dev.db
chown -R www:www prisma/prisma
```

## 六、构建项目

```bash
cd /www/wwwroot/hsfzfx
npm run build
```

**重要提示**：
- `npm run build` 只是构建项目，生成生产版本的文件到 `.next` 目录
- **构建完成后不会自动启动服务器**，需要手动启动
- 构建成功后，会看到类似 "Compiled successfully" 的提示

构建完成后，会生成 `.next` 目录。

**验证构建是否成功**：
```bash
# 检查 .next 目录是否存在
ls -la .next
```

## 七、启动网站

构建完成后，需要启动服务器才能访问网站。有两种方式：

### 7.1 临时测试（不推荐生产环境）

如果想先测试一下网站是否正常，可以临时运行：

```bash
cd /www/wwwroot/hsfzfx
npm start
```

这会启动服务器，但关闭终端后服务会停止。**生产环境请使用 PM2**。

### 7.2 使用 PM2 启动（推荐生产环境）

PM2 可以保持服务持续运行，即使关闭终端也不会停止。

## 八、配置 PM2 启动项目

### 8.1 方式一：使用宝塔 PM2 管理器（推荐）

1. 打开 **PM2 管理器**
2. 点击 **添加项目**
3. 配置如下：
   - **项目名称**: `hsfx-site`（注意：不是 `hsfzfx`）
   - **项目路径**: `/www/wwwroot/hsfzfx`
   - **启动文件**: `npm`
   - **启动参数**: `start`
   - **运行模式**: `生产模式`
   - **Node 版本**: 选择已安装的 Node.js 18+
4. 点击 **提交**
5. 点击 **启动** 按钮

**验证 PM2 是否启动成功**：
- 在 PM2 管理器中查看进程状态，应该显示为 **运行中**
- 或者执行：`pm2 list`，应该能看到 `hsfx-site` 进程

### 8.2 方式二：使用命令行 PM2

如果使用命令行，执行：

```bash
cd /www/wwwroot/hsfzfx

# 方式一：使用 ecosystem.config.js 配置文件
pm2 start ecosystem.config.js

# 方式二：直接启动
pm2 start npm --name "hsfx-site" -- start

# 保存进程列表（重启后自动恢复）
pm2 save

# 设置开机自启（可选）
pm2 startup
```

**检查 PM2 状态**：
```bash
# 查看所有进程
pm2 list

# 查看日志
pm2 logs hsfx-site

# 查看详细信息
pm2 info hsfx-site
```

**常用 PM2 命令**：
```bash
pm2 restart hsfx-site    # 重启应用
pm2 stop hsfx-site       # 停止应用
pm2 delete hsfx-site     # 删除应用
pm2 logs hsfx-site       # 查看日志
```

## 九、配置 Nginx 反向代理

### 9.1 在宝塔面板中创建站点

1. 进入 **网站** → **添加站点**
2. 填写域名（例如：`2025fx.hsfz.live`）或使用 IP
3. 选择 **纯静态** 或 **PHP 项目**（不影响，后面会修改配置）
4. 点击 **提交**

### 9.2 方式一：使用宝塔反向代理功能（推荐，图形界面）

这是最简单的方式，使用宝塔面板提供的反向代理功能：

1. 在 **网站** 列表中找到刚创建的站点
2. 点击 **设置** → **反向代理**
3. 点击 **添加反向代理**
4. 配置如下：
   - **代理名称**: `proxy_nextjs`（可自定义）
   - **代理目录**: `/`（根目录，代理所有请求）
   - **目标 URL**: `http://127.0.0.1:3000`（**重要：必须是本地地址和端口**）
   - **发送域名**: `2025fx.hsfz.live`（填写您的域名）
   - **启用缓存**: 可选，建议开启
5. 点击 **提交**

**重要提示**：
- ⚠️ **目标 URL 必须是 `http://127.0.0.1:3000` 或 `http://localhost:3000`**
- ❌ **不要填写外部域名**（如 `http://2025fx.hsfz.live`），那样会代理外部网站而不是本地应用
- ✅ **发送域名** 填写您的实际域名（如 `2025fx.hsfz.live`）

### 9.3 方式二：手动修改 Nginx 配置文件

1. 在 **网站** 列表中找到刚创建的站点
2. 点击 **设置** → **配置文件**
3. 删除默认配置，替换为以下内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名或IP
    
    # 日志
    access_log /www/wwwlogs/hsfzfx-access.log;
    error_log /www/wwwlogs/hsfzfx-error.log;

    # 反向代理到 Next.js 应用
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Next.js 静态资源缓存
    location /_next/static/ {
        proxy_pass http://127.0.0.1:3000;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    # 图片等资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3000;
        expires 7d;
        add_header Cache-Control "public";
    }
}
```

4. 点击 **保存**
5. 点击 **重载配置**

### 9.4 如果使用 IP 访问

如果使用 IP 访问，在反向代理配置中：
- **发送域名** 可以留空或填写 IP 地址
- 或者在 Nginx 配置中将 `server_name` 改为：
```nginx
server_name _;
```

### 9.5 验证反向代理配置

配置完成后：

1. **检查 PM2 进程是否运行**
   ```bash
   pm2 list
   # 确保 hsfx-site 进程正在运行
   ```

2. **测试本地服务**
   ```bash
   curl http://127.0.0.1:3000
   # 应该返回 HTML 内容
   ```

3. **测试域名访问**
   ```bash
   curl http://2025fx.hsfz.live
   # 应该返回相同的 HTML 内容
   ```

4. **检查 Nginx 配置**
   - 在宝塔面板：**网站** → **设置** → **配置文件**
   - 应该能看到类似以下的反向代理配置：
   ```nginx
   location / {
       proxy_pass http://127.0.0.1:3000;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       # ... 其他配置
   }
   ```

## 十、配置 SSL 证书（HTTPS）

### 10.1 使用宝塔免费 SSL

1. 在网站 **设置** → **SSL**
2. 选择 **Let's Encrypt** 免费证书
3. 填写域名和邮箱
4. 点击 **申请**
5. 申请成功后，开启 **强制 HTTPS**

### 10.2 修改 Nginx 配置支持 HTTPS

申请 SSL 后，宝塔会自动修改配置。如果需要手动调整，确保配置包含：

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /www/server/panel/vhost/cert/your-domain.com/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/your-domain.com/privkey.pem;
    
    # ... 其他配置同上
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

## 十一、设置文件权限

确保项目目录权限正确：

```bash
cd /www/wwwroot/hsfzfx
chown -R www:www .
chmod -R 755 .
```

对于数据库文件，需要确保可写：

```bash
# 确保数据库目录存在
mkdir -p prisma/prisma

# 设置目录权限
chmod 755 prisma/prisma

# 如果数据库文件已存在，设置文件权限
if [ -f prisma/prisma/dev.db ]; then
    chmod 666 prisma/prisma/dev.db
    chown www:www prisma/prisma/dev.db
fi

# 确保整个 prisma 目录的所有者是 www 用户
chown -R www:www prisma
```

**重要提示**：
- 数据库文件需要 `www` 用户（Nginx/PHP-FPM 用户）有读写权限
- 如果使用 PM2 运行，确保 PM2 进程的用户也有权限访问数据库文件
- 可以通过 `ps aux | grep node` 查看 PM2 进程的运行用户

## 十二、防火墙设置

1. 在宝塔面板进入 **安全**
2. 确保以下端口已开放：
   - **80** (HTTP)
   - **443** (HTTPS)
   - **3000** (Next.js，仅本地访问，不需要对外开放)
   - **22** (SSH，如果使用)

## 十三、验证部署

1. 在浏览器访问您的域名或 IP
2. 检查网站是否正常显示
3. 检查 PM2 管理器中的进程状态（应该显示为 **运行中**）
4. 查看日志：
   - PM2 日志：在 PM2 管理器中查看
   - Nginx 日志：在网站设置 → 日志中查看
   - 应用日志：`/www/wwwroot/hsfzfx/.next/` 目录

## 十四、常见问题排查

### 14.0 快速修复数据库错误（"Unable to open the database file"）

如果遇到数据库无法打开的错误，有两种修复方式：

#### 方式一：使用自动修复脚本（推荐）

项目提供了一个自动修复脚本，可以一键解决大部分数据库问题：

```bash
cd /www/wwwroot/hsfzfx
bash scripts/fix-database.sh
```

脚本会自动：
- 检查并创建 `.env` 文件
- 创建数据库目录和文件
- 设置正确的文件权限
- 生成 Prisma Client
- 运行数据库迁移

#### 方式二：手动修复

如果遇到数据库无法打开的错误，按以下步骤快速修复：

```bash
# 1. 进入项目目录
cd /www/wwwroot/hsfzfx

# 2. 确保数据库目录存在
mkdir -p prisma/prisma

# 3. 检查 .env 文件是否存在且配置正确
cat .env | grep DATABASE_URL

# 4. 如果数据库文件不存在，创建并初始化
if [ ! -f prisma/prisma/dev.db ]; then
    touch prisma/prisma/dev.db
    npm run prisma:migrate
fi

# 5. 设置正确的权限
chmod 755 prisma/prisma
chmod 666 prisma/prisma/dev.db
chown -R www:www prisma

# 6. 重新生成 Prisma Client
npm run prisma:generate

# 7. 重新构建项目
npm run build

# 8. 重启 PM2 进程
pm2 restart hsfx-site
```

**如果仍然失败，检查以下几点：**

1. **确认 .env 文件路径正确**
   ```bash
   # 使用绝对路径（推荐）
   echo 'DATABASE_URL="file:/www/wwwroot/hsfzfx/prisma/prisma/dev.db"' >> .env
   ```

2. **检查 PM2 运行用户**
   ```bash
   ps aux | grep node
   # 如果 PM2 不是以 www 用户运行，需要修改权限或更改运行用户
   ```

3. **检查 SELinux（如果启用）**
   ```bash
   # CentOS/RHEL 系统可能需要设置 SELinux 上下文
   chcon -R -t httpd_sys_content_t prisma/prisma
   ```

### 14.1 后台登录问题

#### 问题：开发环境可以登录，生产环境无法登录后台

**症状**：
- `npm run dev` 可以正常登录
- `npm run build` + `npm start` 后无法登录
- 登录后页面刷新但不跳转

**原因**：

生产环境下，Cookie 设置了 `secure: true`，要求通过 **HTTPS** 访问。如果使用 **HTTP** 访问（未配置 SSL），浏览器会拒绝设置 Cookie，导致登录失败。

**解决方案**：

**方案一：配置 HTTPS（推荐）**

1. 在宝塔面板：网站设置 → SSL
2. 申请 Let's Encrypt 免费证书
3. 开启强制 HTTPS
4. 使用 `https://` 访问网站

**方案二：临时允许 HTTP 访问（仅测试环境）**

1. 编辑 `.env` 文件，添加：
   ```env
   FORCE_HTTP=true
   ```

2. 重新构建和重启：
   ```bash
   cd /www/wwwroot/hsfzfx
   npm run build
   pm2 restart hsfx-site
   ```

3. 清除浏览器 Cookie 和缓存

4. 重新登录

**验证修复**：

打开浏览器开发者工具（F12）→ Application → Cookies，登录后应能看到 `hf_admin_auth` Cookie。

**安全建议**：
- ⚠️ 生产环境务必配置 HTTPS
- ⚠️ 配置 HTTPS 后删除 `FORCE_HTTP=true`
- ⚠️ 不要在公网环境使用 HTTP 访问管理后台

### 14.2 网站无法访问

#### 问题：构建成功但网站无法访问

**原因**：`npm run build` 只是构建项目，不会启动服务器。

**解决方案**：

1. **检查 PM2 是否运行**
   ```bash
   pm2 list
   # 如果没有看到 hsfx-site 进程，需要启动它
   ```

2. **启动 PM2 进程**
   ```bash
   cd /www/wwwroot/hsfzfx
   pm2 start npm --name "hsfx-site" -- start
   # 或使用配置文件
   pm2 start ecosystem.config.js
   ```

3. **检查端口是否被占用**
   ```bash
   netstat -tlnp | grep 3000
   # 或
   lsof -i :3000
   ```

4. **检查 Next.js 服务是否正常启动**
   ```bash
   # 查看 PM2 日志
   pm2 logs hsfx-site
   
   # 手动测试（临时启动）
   cd /www/wwwroot/hsfzfx
   npm start
   # 如果手动启动正常，说明问题在 PM2 配置
   ```

5. **验证服务是否响应**
   ```bash
   # 在服务器上测试本地连接
   curl http://localhost:3000
   # 如果返回 HTML 内容，说明服务正常
   ```

#### 其他常见问题

1. **检查端口占用**
   ```bash
   netstat -tlnp | grep 3000
   ```

2. **检查 Nginx 配置**
   ```bash
   nginx -t
   ```

3. **检查防火墙**
   - 确保 80/443 端口已开放

### 14.3 数据库错误

#### 错误：Unable to open the database file

这是最常见的数据库错误，通常由以下原因引起：

1. **数据库文件不存在**
   ```bash
   # 检查文件是否存在
   ls -la prisma/prisma/dev.db
   
   # 如果不存在，创建并初始化
   mkdir -p prisma/prisma
   touch prisma/prisma/dev.db
   npm run prisma:migrate
   ```

2. **数据库文件权限问题**
   ```bash
   # 检查权限
   ls -la prisma/prisma/dev.db
   
   # 设置正确权限
   chmod 666 prisma/prisma/dev.db
   chmod 755 prisma/prisma
   chown www:www prisma/prisma/dev.db
   ```

3. **数据库路径错误**
   - 检查 `.env` 文件中的 `DATABASE_URL`
   - 如果使用相对路径，确保是相对于项目根目录
   - 推荐使用绝对路径：`DATABASE_URL="file:/www/wwwroot/hsfzfx/prisma/prisma/dev.db"`

4. **数据库目录不存在**
   ```bash
   # 确保目录存在
   mkdir -p prisma/prisma
   chmod 755 prisma/prisma
   ```

5. **重新生成 Prisma Client**
   ```bash
   npm run prisma:generate
   ```

6. **检查环境变量是否生效**
   ```bash
   # 在项目目录下执行
   cd /www/wwwroot/hsfzfx
   node -e "require('dotenv').config(); console.log(process.env.DATABASE_URL)"
   ```

#### 构建时的数据库错误

如果在 `npm run build` 时出现数据库错误：

1. **确保在构建前数据库已初始化**
   ```bash
   # 先初始化数据库
   npm run prisma:generate
   npm run prisma:migrate
   
   # 然后再构建
   npm run build
   ```

2. **检查构建时的环境变量**
   - 确保 `.env` 文件在项目根目录
   - 确保 `DATABASE_URL` 路径正确

3. **如果使用相对路径，尝试改为绝对路径**
   ```env
   DATABASE_URL="file:/www/wwwroot/hsfzfx/prisma/prisma/dev.db"
   ```

### 14.4 构建失败

1. **清理缓存重新构建**
   ```bash
   rm -rf .next node_modules
   npm install
   npm run build
   ```

2. **检查 Node.js 版本**
   ```bash
   node -v  # 应该是 18.x 或更高
   ```

### 14.4 静态资源加载失败

1. **检查 Nginx 配置中的静态资源路径**
2. **检查文件权限**
3. **清除浏览器缓存**

## 十五、更新项目

当需要更新项目时：

1. **备份当前版本**（可选）
   ```bash
   cp -r /www/wwwroot/hsfzfx /www/wwwroot/hsfzfx.backup
   ```

2. **拉取最新代码**（如果使用 Git）
   ```bash
   cd /www/wwwroot/hsfzfx
   git pull
   ```

3. **或上传新文件**（如果手动上传）

4. **重新安装依赖**（如果 package.json 有变化）
   ```bash
   npm install
   ```

5. **重新生成 Prisma Client**（如果数据库 schema 有变化）
   ```bash
   npm run prisma:generate
   npm run prisma:migrate
   ```

6. **重新构建**
   ```bash
   npm run build
   ```

7. **重启 PM2 进程**
   - 在 PM2 管理器中点击 **重启**
   - 或命令行：`pm2 restart hsfx-site`

## 十六、性能优化建议

### 16.1 开启 Gzip 压缩

在 Nginx 配置中添加：

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
```

### 16.2 设置缓存策略

已在配置文件中包含静态资源缓存，可根据需要调整。

### 16.3 PM2 集群模式（可选）

如果服务器性能较好，可以启用多实例：

修改 `ecosystem.config.js`：
```javascript
instances: 2,  // 或 'max' 使用所有 CPU 核心
```

## 十七、备份建议

### 17.1 定期备份

1. **数据库文件**
   ```bash
   cp prisma/prisma/dev.db /backup/dev.db.$(date +%Y%m%d)
   ```

2. **项目文件**
   - 使用宝塔面板的 **计划任务** 设置自动备份
   - 或使用 Git 定期提交

3. **上传的文件**
   - 备份 `public/uploads/` 目录

## 完成！

现在您的 Next.js 项目应该已经成功部署到宝塔面板上了。如果遇到任何问题，请参考 **常见问题排查** 部分，或查看相关日志文件。

